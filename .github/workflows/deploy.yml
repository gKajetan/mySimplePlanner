name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy_to_production:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          # ---------------------------------------------------
          # CRITICAL FIXES
          script_stop: true # Fail immediately if any command errors
          request_pty: true # Force a pseudo-terminal (fixes your specific VPS issue)
          # ---------------------------------------------------
          command_timeout: 15m
          envs: GITHUB_TOKEN
          script: |
          
            cd /home/${{ secrets.SSH_USERNAME }}/production/mySimplePlanner

            echo "--- DOCKER OPERATIONS ---"
            sudo docker compose down 

            echo "--- GIT PULL ---"
            # Reset ensures we don't have local conflict changes blocking the pull
            git reset --hard
            git pull origin main --force

            echo "--- REBUILD & START ---"
            sudo docker compose up --build -d

            echo "--- DEPLOYMENT SUCCESSFUL ---"
